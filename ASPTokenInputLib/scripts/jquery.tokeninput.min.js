(function(n){var f={method:"POST",dataType:"json",contentType:"application/json; charset=utf-8",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:"|",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(n){return"<li>"+n[this.propertyToSearch]+"<\/li>"},tokenFormatter:function(n){return"<li><p>"+n[this.propertyToSearch]+"<\/p><\/li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},r={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},i={BEFORE:0,AFTER:1,END:2},t={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},u={init:function(t,i){var r=n.extend({},f,i||{});return this.each(function(){n(this).data("tokenInputObject",new n.TokenList(this,t,r))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(n){return this.data("tokenInputObject").add(n),this},remove:function(n){return this.data("tokenInputObject").remove(n),this},get:function(){return this.data("tokenInputObject").getTokens()}};n.fn.tokenInput=function(n){return u[n]?u[n].apply(this,Array.prototype.slice.call(arguments,1)):u.init.apply(this,arguments)},n.TokenList=function(u,f,e){function lt(){if(e.tokenLimit!==null&&v>=e.tokenLimit){o.hide(),w();return}}function pt(){if(ut!==(ut=o.val())){var n=ut.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");ct.html(n),o.width(ct.width()+30)}}function at(t){var i=e.tokenFormatter(t),r;return i=n(i).addClass(e.classes.token).insertBefore(p),n("<span>"+e.deleteText+"<\/span>").addClass(e.classes.tokenDelete).appendTo(i).click(function(){return nt(n(this).parent()),h.change(),!1}),r={id:t.id},r[e.propertyToSearch]=t[e.propertyToSearch],n.data(i.get(0),"tokeninput",t),c=c.slice(0,l).concat([r]).concat(c.slice(l)),l++,vt(c,h),v+=1,e.tokenLimit!==null&&v>=e.tokenLimit&&(o.hide(),w()),i}function ft(t){var r=e.onAdd,i;if(v>0&&e.preventDuplicates&&(i=null,y.children().each(function(){var r=n(this),u=n.data(r.get(0),"tokeninput");if(u&&u.id==t.id)return i=r,!1}),i)){g(i),p.insertAfter(i),o.focus();return}(e.tokenLimit==null||v<e.tokenLimit)&&(at(t),lt()),o.val(""),w(),n.isFunction(r)&&r.call(h,t)}function g(n){n.addClass(e.classes.selectedToken),s=n.get(0),o.val(""),w()}function d(n,t){n.removeClass(e.classes.selectedToken),s=null,t===i.BEFORE?(p.insertBefore(n),l--):t===i.AFTER?(p.insertAfter(n),l++):(p.appendTo(y),l=v),o.focus()}function wt(t){var r=s;s&&d(n(s),i.END),r===t.get(0)?d(t,i.END):g(t)}function nt(t){var u=n.data(t.get(0),"tokeninput"),r=e.onDelete,i=t.prevAll().length;i>l&&i--,t.remove(),s=null,o.focus(),c=c.slice(0,i).concat(c.slice(i+1)),i<l&&l--,vt(c,h),v-=1,e.tokenLimit!==null&&o.show().val("").focus(),n.isFunction(r)&&r.call(h,u)}function vt(t,i){var r=n.map(t,function(n){return n[e.tokenValue]});i.val(r.join(e.tokenDelimiter))}function w(){b.hide().empty(),a=null}function tt(){b.css({position:"absolute",top:n(y).offset().top+n(y).outerHeight(),left:n(y).offset().left,zindex:999}).show()}function bt(){e.searchingText&&(b.html("<p>"+e.searchingText+"<\/p>"),tt())}function kt(n,t){return n.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1<\/b>")}function dt(n,t,i){return n.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","g"),kt(t,i))}function et(t,i){if(i&&i.length){b.empty();var r=n("<ul>").appendTo(b).mouseover(function(t){ot(n(t.target).closest("li"))}).mousedown(function(t){return ft(n(t.target).closest("li").data("tokeninput")),h.change(),!1}).hide();n.each(i,function(i,u){var f=e.resultsFormatter(u);f=dt(f,u[e.propertyToSearch],t),f=n(f).appendTo(r),i%2?f.addClass(e.classes.dropdownItem):f.addClass(e.classes.dropdownItem2),i===0&&ot(f),n.data(f.get(0),"tokeninput",u)}),tt(),e.animateDropdown?r.slideDown("fast"):r.show()}else e.noResultsText&&(b.html("<p>"+e.noResultsText+"<\/p>"),tt())}function ot(t){t&&(a&&gt(n(a)),t.addClass(e.classes.selectedDropdownItem),a=t.get(0))}function gt(n){n.removeClass(e.classes.selectedDropdownItem),a=null}function yt(){var t=o.val().toLowerCase();t&&t.length&&(s&&d(n(s),i.AFTER),t.length>=e.minChars?(bt(),clearTimeout(ht),ht=setTimeout(function(){ni(t)},e.searchDelay)):w())}function ni(t){var f=t+st(),c=rt.get(f),u,i,s,l,r;c?et(t,c):e.url?(u=st(),i={},i.data="{'q':'"+t+"'}",u.indexOf("?")>-1?(s=u.split("?"),i.url=s[0],l=s[1].split("&"),n.each(l,function(n,t){var r=t.split("=");i.data[r[0]]=r[1]})):i.url=u,i.type=e.method,i.dataType=e.dataType,i.contentType=e.contentType,e.crossDomain&&(i.dataType="jsonp"),i.success=function(i){i=n.parseJSON(i.d),n.isFunction(e.onResult)&&(i=e.onResult.call(h,i)),rt.add(f,e.jsonContainer?i[e.jsonContainer]:i),o.val().toLowerCase()===t&&et(t,e.jsonContainer?i[e.jsonContainer]:i)},n.ajax(i)):e.local_data&&(r=n.grep(e.local_data,function(n){return n[e.propertyToSearch].toLowerCase().indexOf(t.toLowerCase())>-1}),n.isFunction(e.onResult)&&(r=e.onResult.call(h,r)),rt.add(f,r),et(t,r))}function st(){var n=e.url;return typeof e.url=="function"&&(n=e.url.call()),n}var it,k;n.type(f)==="string"||n.type(f)==="function"?(e.url=f,it=st(),e.crossDomain===undefined&&(e.crossDomain=it.indexOf("://")===-1?!1:location.href.split(/\/+/g)[1]!==it.split(/\/+/g)[1])):typeof f=="object"&&(e.local_data=f),e.classes?e.classes=n.extend({},r,e.classes):e.theme?(e.classes={},n.each(r,function(n,t){e.classes[n]=t+"-"+e.theme})):e.classes=r;var c=[],v=0,rt=new n.TokenList.Cache,ht,ut,o=n('<input type="text"  autocomplete="off" value="'+e.hintText+'">').css({outline:"none"}).attr("id",e.idPrefix+u.id).focus(function(){(e.tokenLimit===null||e.tokenLimit!==v)&&n(this).val("")}).blur(function(){w(),n(this).val(e.hintText)}).bind("keyup keydown blur update",pt).keydown(function(r){var u,f,e;switch(r.keyCode){case t.LEFT:case t.RIGHT:case t.UP:case t.DOWN:if(n(this).val())return e=null,e=r.keyCode===t.DOWN||r.keyCode===t.RIGHT?n(a).next():n(a).prev(),e.length&&ot(e),!1;u=p.prev(),f=p.next(),u.length&&u.get(0)===s||f.length&&f.get(0)===s?r.keyCode===t.LEFT||r.keyCode===t.UP?d(n(s),i.BEFORE):d(n(s),i.AFTER):(r.keyCode===t.LEFT||r.keyCode===t.UP)&&u.length?g(n(u.get(0))):(r.keyCode===t.RIGHT||r.keyCode===t.DOWN)&&f.length&&g(n(f.get(0)));break;case t.BACKSPACE:if(u=p.prev(),n(this).val().length)n(this).val().length===1?w():setTimeout(function(){yt()},5);else return s?(nt(n(s)),h.change()):u.length&&g(n(u.get(0))),!1;break;case t.TAB:case t.ENTER:case t.NUMPAD_ENTER:case t.COMMA:if(a)return ft(n(a).data("tokeninput")),h.change(),!1;break;case t.ESCAPE:return w(),!0;default:String.fromCharCode(r.which)&&setTimeout(function(){yt()},5)}}),h=n(u).hide().val("").focus(function(){o.focus()}).blur(function(){o.blur()}),s=null,l=0,a=null,y=n("<ul />").addClass(e.classes.tokenList).click(function(t){var r=n(t.target).closest("li");r&&r.get(0)&&n.data(r.get(0),"tokeninput")?wt(r):(s&&d(n(s),i.END),o.focus())}).mouseover(function(t){var i=n(t.target).closest("li");i&&s!==this&&i.addClass(e.classes.highlightedToken)}).mouseout(function(t){var i=n(t.target).closest("li");i&&s!==this&&i.removeClass(e.classes.highlightedToken)}).insertBefore(h),p=n("<li />").addClass(e.classes.inputToken).appendTo(y).append(o),b=n("<div>").addClass(e.classes.dropdown).appendTo("body").hide(),ct=n("<tester/>").insertAfter(o).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:o.css("fontSize"),fontFamily:o.css("fontFamily"),fontWeight:o.css("fontWeight"),letterSpacing:o.css("letterSpacing"),whiteSpace:"nowrap"});h.val(""),k=e.prePopulate||h.data("pre"),e.processPrePopulate&&n.isFunction(e.onResult)&&(k=e.onResult.call(h,k)),k&&k.length&&n.each(k,function(n,t){at(t),lt()}),n.isFunction(e.onReady)&&e.onReady.call(),this.clear=function(){y.children("li").each(function(){n(this).children("input").length===0&&nt(n(this))})},this.add=function(n){ft(n)},this.remove=function(t){y.children("li").each(function(){var u,i,r;if(n(this).children("input").length===0){u=n(this).data("tokeninput"),i=!0;for(r in t)if(t[r]!==u[r]){i=!1;break}i&&nt(n(this))}})},this.getTokens=function(){return c}},n.TokenList.Cache=function(t){var u=n.extend({max_size:500},t),i={},r=0,f=function(){i={},r=0};this.add=function(n,t){r>u.max_size&&f(),i[n]||(r+=1),i[n]=t},this.get=function(n){return i[n]}}})(jQuery);